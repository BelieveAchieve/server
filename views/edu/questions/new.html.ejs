<%- contentFor('title') %>
UPchieve EDU Admin | New Question

<%- contentFor('head') %>
<style type="text/css" media="screen">
    label {
        display: block;
        font-weight: bold;
    }

    .question-tile {
        border-width: .2rem;
        border: solid #f7f7f9;
    }

    .alert {
      top: 14px;
      padding-top: 0.55rem;
      padding-bottom: 0.55rem;
    }
</style>

<%- contentFor('body') %>
<h1>New Question</h1>
<a href="/edu" class="btn btn-secondary d-inline" style="height: 35px;">edu admin</a>
<a href="/edu/questions" class="btn btn-secondary d-inline" style="height: 35px;">all questions</a>
<a href="/edu/questions/new" class="btn btn-secondary d-inline" style="height: 35px;">new question</a>

<div class="question-tile mt-4 mb-4 js-question-tile" id="new">
    <div class="m-4 p-4 js-question-rendered d-none">
        <div class="ml-4 small">
          <a
            id="new-category-link"
            href="/edu/questions?category=<%= encodeURIComponent(question.category) %>">
            <span id="new-category">
              <%= question.category %>
            </span>
          </a>
          &gt;
          <a
            id="new-subcategory-link"
            href="/edu/questions?subcategory=<%= encodeURIComponent(question.subcategory) %>">
            <span id="new-subcategory">
              <%= question.subcategory %>
            </span>
          </a>
        </div>

        <div class="m-4" id="new-questionText">
            <%= question.questionText %>
        </div>

        <% if (question.image) { %>
          <img
            data-image-path="/static/question_images"
            src="/static/question_images/<%= question.image %>" />
        <% } %>

        <div class="m-4">
            <ul>
                <% question.possibleAnswers.forEach(({txt, val}) => { %>
                <div
                  id="new-possibleAnswers-<%= val %>"
                  class="<%= (val === question.correctAnswer) ? 'font-weight-bold' : '' %>"
                >
                  <%= val %>. <%= txt %>
                </div>
                <% }) %>
            </ul>
        </div>

        <button type="button" class="mt-4 ml-4 mr-4 mb-0 btn btn-danger js-delete-button">Delete</button>
        <span class="js-tile-flash"></span>
    </div>

    <form class="m-4 p-4 js-question-form" action="/edu/questions" method="post">
        <div class="form-group">
            <label for="questionText">Question text</label>
            <textarea
              name="questionText"
              class="form-control"
              required><%= question.questionText %></textarea>
        </div>

        <div class="form-group">
            <% if (question.image) { %>
              <img
                data-image-path="/static/question_images"
                src="/static/question_images/<%= question.image %>" />
            <% } %>
            <label for="image">Image filename</label>
            <input
              type="text"
              name="image"
              value="<%= question.image %>"
              class="form-control"
            />
        </div>

        <div class="form-group">
            <label for="possibleAnswers">Answer choices (at least two are required)</label>
            <% question.possibleAnswers.forEach(({txt, val}, i) => { %>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <%= val %>
                  </span>
                </div>
                <input
                  type="hidden"
                  name="possibleAnswers[][val]"
                  value="<%= val %>"
                  <%= (i < 2) ? 'required' : '' %>
                />
                <input
                  type="text"
                  name="possibleAnswers[][txt]"
                  value="<%= txt %>"
                  class="form-control"
                  <%= (i < 2) ? 'required' : '' %>
                />
            </div>
            <% }) %>
        </div>

        <div class="form-group">
            <label for="correctAnswer">Correct Answer</label>
            <input
              type="text"
              name="correctAnswer"
              value="<%= question.correctAnswer %>"
              class="form-control"
              required
            />
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <input
              type="text"
              name="category"
              value="<%= question.category %>"
              class="form-control"
              required
            />
        </div>

        <div class="form-group">
            <label for="subcategory">Subcategory</label>
            <input
              type="text"
              name="subcategory"
              value="<%= question.subcategory %>"
              class="form-control"
              required
            />
        </div>

        <button type="button" class="mt-4 btn btn-primary js-save-button">Save</button>
        <button type="button" class="mt-4 btn btn-secondary js-cancel-button">Cancel</button>
        <span class="mt-4 mb-0 js-form-flash"></span>
    </form>
</div>

<%- contentFor('scripts') %>
<script>
  $('.js-question-tile').on('click', '.js-cancel-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    $tile.find('.js-question-form').addClass('d-none')
    $tile.find('.js-question-rendered').removeClass('d-none')
  })

  $('.js-question-tile').on('click', '.js-save-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    const $tileFlash = $tile.find('.js-tile-flash')
    $tileFlash.removeClass('alert alert-danger alert-success')

    const $form = $tile.find('.js-question-form').first()
    if (!$form.valid()) { return }

    const $formFlash = $form.find('.js-form-flash')
    $formFlash.removeClass('alert alert-danger alert-success')

    const question = $form.serializeJSON()
    question.possibleAnswers = question.possibleAnswers.filter(e => e.txt)

    const request = {
      type: $form.attr('method'),
      contentType: 'application/json; charset=utf-8',
      url: $form.attr('action'),
      data: JSON.stringify({ question }),
      dataType: 'json'
    }

    $.ajax(request).done(resp => {
      const {
        _id,
        category,
        subcategory,
        questionText,
        possibleAnswers,
        correctAnswer,
        image
      } = resp.question

      const categoryUri = encodeURIComponent(category)
      const subUri = encodeURIComponent(subcategory)
      $tile.attr('id', _id)
      $tile.find(`#new-category-link`).attr('href', `/edu/questions?category=${categoryUri}`)
      $tile.find(`#new-subcategory-link`).attr('href', `/edu/questions?subcategory=${subUri}`)
      $tile.find(`#new-category`).text(category)
      $tile.find(`#new-subcategory`).text(subcategory)
      $tile.find(`#new-questionText`).text(questionText)

      if (image) {
        $tile.find('img').removeClass('d-none')
        $form.find('img').removeClass('d-none')

        const path = $tile.find('img').data('image-path')
        $tile.find('img').attr('src', `${path}/${image}`)
        $form.find('img').attr('src', `${path}/${image}`)
      } else {
        $tile.find('img').addClass('d-none')
        $form.find('img').addClass('d-none')
      }

      possibleAnswers.forEach(({val, txt}) => {
        const $option = $tile.find(`#new-possibleAnswers-${val}`)
        $option.text(`${val}. ${txt}`).removeClass('font-weight-bold')
        if (val === correctAnswer) {
          $option.addClass('font-weight-bold')
        }
      })

      $tileFlash.text('Update succeeded.')
      $tileFlash.addClass('alert alert-success')

      $tile.find('.js-question-form').addClass('d-none')
      $tile.find('.js-question-rendered').removeClass('d-none')

      // re-typeset math
      MathJax.Hub.Queue(['Typeset', MathJax.Hub, $tile[0]])
    }).fail(resp => {
      console.error('Request failed. Sent:', request)
      console.error(`Received ${resp.status} response: `, resp.responseText)
      $formFlash.text('Update failed.')
      $formFlash.addClass('alert alert-danger')
    })
  })

  $('.js-question-tile').on('click', '.js-delete-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    const $tileFlash = $tile.find('.js-tile-flash')
    const questionId = $tile.attr('id')
    $tileFlash.removeClass('alert alert-danger alert-success')

    const $form = $tile.find('.js-question-form').first()
    const $formFlash = $form.find('.js-form-flash')
    $formFlash.removeClass('alert alert-danger alert-success')

    const request = {
      type: 'delete',
      contentType: 'application/json; charset=utf-8',
      url: `/edu/questions/${questionId}`,
      dataType: 'json'
    }

    $.ajax(request).done(resp => {
      $tileFlash.text('Successfully deleted')
      $tileFlash.addClass('alert alert-success')
    }).fail(resp => {
      console.error('Request failed. Sent:', request)
      console.error(`Received ${resp.status} response: `, resp.responseText)
      $formFlash.text('Update failed.')
      $formFlash.addClass('alert alert-danger')
    })
  })
</script>
