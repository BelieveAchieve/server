<%- contentFor('title') %>
UPchieve EDU Admin | Questions

<%- contentFor('head') %>
<style type="text/css" media="screen">
  label {
    display: block;
    font-weight: bold;
  }

  .question-tile {
    border-width: .2rem;
    border: solid #f7f7f9;
  }

  .alert {
    top: 14px;
    padding-top: 0.55rem;
    padding-bottom: 0.55rem;
  }
</style>

<%- contentFor('body') %>
<h1>Questions</h1>
<a href="/edu" class="btn btn-secondary d-inline" style="height: 35px;">index</a>
<a href="/edu/questions" class="btn btn-secondary d-inline" style="height: 35px;">clear filters</a>
<a href="/edu/questions/new" class="btn btn-secondary d-inline" style="height: 35px;">new question</a>

<% questions.forEach(question => { %>
<div class="question-tile mt-4 mb-4 js-question-tile" id="<%= question._id %>">
    <div class="m-4 p-4 js-question-rendered">
        <div class="ml-4 small">
          <a
            id="<%= question._id %>-category-link"
            href="/edu/questions?category=<%= encodeURIComponent(question.category) %>">
            <span id="<%= question._id %>-category">
              <%= question.category %>
            </span>
          </a>
          &gt;
          <a
            id="<%= question._id %>-subcategory-link"
            href="/edu/questions?subcategory=<%= encodeURIComponent(question.subcategory) %>">
            <span id="<%= question._id %>-subcategory">
              <%= question.subcategory %>
            </span>
          </a>
        </div>

        <div class="m-4" id="<%= question._id %>-questionText">
            <%= question.questionText %>
        </div>

        <% if (question.image) { %>
          <img
            data-image-path="/static/question_images"
            src="/static/question_images/<%= question.image %>" />
        <% } %>

        <div class="m-4">
            <ul>
                <% question.possibleAnswers.forEach(({txt, val}) => { %>
                <div
                  id="<%= question._id %>-possibleAnswers-<%= val %>"
                  class="<%= (val === question.correctAnswer) ? 'font-weight-bold' : '' %>"
                >
                  <%= val %>. <%= txt %>
                </div>
                <% }) %>
            </ul>
        </div>

        <button type="button" class="mt-4 ml-4 mr-0 mb-0 btn btn-primary js-edit-button">Edit</button>
        <button type="button" class="mt-4 ml-0 mr-4 mb-0 btn btn-danger js-delete-button">Delete</button>
        <span class="js-tile-flash"></span>
    </div>

    <form class="m-4 p-4 js-question-form d-none" action="/edu/questions/<%= question._id %>" method="put">
        <div class="form-group">
            <label for="questionText">Question text</label>
            <textarea name="questionText" class="form-control"><%= question.questionText %></textarea>
        </div>

        <div class="form-group">
            <% if (question.image) { %>
              <img
                data-image-path="/static/question_images"
                src="/static/question_images/<%= question.image %>" />
            <% } %>
            <label for="image">Image filename</label>
            <input
              type="text"
              name="image"
              value="<%= question.image %>"
              class="form-control" />
        </div>

        <div class="form-group">
            <label for="possibleAnswers">Answer choices</label>
            <% question.possibleAnswers.forEach(({txt, val}, i) => { %>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <%= val %>
                  </span>
                </div>
                <input
                  type="hidden"
                  name="possibleAnswers[][val]"
                  value="<%= val %>"/>
                <input
                  type="text"
                  name="possibleAnswers[][txt]"
                  value="<%= txt %>"
                  class="form-control" />
            </div>
            <% }) %>
        </div>

        <div class="form-group">
            <label for="correctAnswer">Correct Answer</label>
            <input
              type="text"
              name="correctAnswer"
              value="<%= question.correctAnswer %>"
              class="form-control" />
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <input
              type="text"
              name="category"
              value="<%= question.category %>"
              class="form-control" />
        </div>

        <div class="form-group">
            <label for="subcategory">Subcategory</label>
            <input
              type="text"
              name="subcategory"
              value="<%= question.subcategory %>"
              class="form-control" />
        </div>

        <button type="button" class="mt-4 btn btn-primary js-save-button">Save</button>
        <button type="button" class="mt-4 btn btn-secondary js-cancel-button">Cancel</button>
        <span class="mt-4 mb-0 js-form-flash"></span>
    </form>
</div>
<% }) %>
</div>


<%- contentFor('scripts') %>
<script>
  const formData = ($form) => {
    const data = {}

    $form.serializeArray().forEach((e, i) => {
      const [key, subkeyAttr] = e['name'].split('[]')
      const value = e['value']
      const matchData = (subkeyAttr || '').match(/\[(\w+)\]/)
      const subkey = matchData && matchData[1]

      if (!subkey) {
        data[key] = value
        return
      }

      const collection = data[key]
      if (collection === undefined) {
        const entry = {}
        entry[subkey] = value
        data[key] = [entry]
        return
      }

      if (Array.isArray(collection)) {
        const lastEntry = collection[collection.length-1]

        if (!lastEntry[subkey]) {
          lastEntry[subkey] = value
        } else {
          // Don't overwrite keys
          const newEntry = {}
          newEntry[subkey] = value
          collection.push(newEntry)
        }
      }
    })

    return data
  }

  $('.js-question-tile').on('click', '.js-edit-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    const $tileFlash = $tile.find('.js-tile-flash')
    $tileFlash.text('').removeClass('alert alert-danger alert-success')
    $tile.find('.js-question-form').removeClass('d-none')
    $tile.find('.js-question-rendered').addClass('d-none')
  })

  $('.js-question-tile').on('click', '.js-cancel-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    const $form = $tile.find('.js-question-form').first()
    const $formFlash = $form.find('.js-form-flash')
    $formFlash.text('').removeClass('alert alert-danger alert-success')
    $tile.find('.js-question-form').addClass('d-none')
    $tile.find('.js-question-rendered').removeClass('d-none')
  })

  $('.js-question-tile').on('click', '.js-save-button', e => {
    e.preventDefault()

    const $tile = $(e.target).closest('.js-question-tile')
    const $tileFlash = $tile.find('.js-tile-flash')
    $tileFlash.removeClass('alert alert-danger alert-success')

    const $form = $tile.find('.js-question-form').first()
    const $formFlash = $form.find('.js-form-flash')
    $formFlash.removeClass('alert alert-danger alert-success')

    const request = {
      type: $form.attr('method'),
      contentType: 'application/json; charset=utf-8',
      url: $form.attr('action'),
      data: JSON.stringify({ question: formData($form) }),
      dataType: 'json'
    }

    $.ajax(request).done(resp => {
      const {
        _id,
        category,
        subcategory,
        questionText,
        possibleAnswers,
        correctAnswer,
        image
      } = resp.question

      const categoryUri = encodeURIComponent(category)
      const subUri = encodeURIComponent(subcategory)
      $tile.find(`#${_id}-category-link`).attr('href', `/edu/questions?category=${categoryUri}`)
      $tile.find(`#${_id}-subcategory-link`).attr('href', `/edu/questions?subcategory=${subUri}`)
      $tile.find(`#${_id}-category`).text(category)
      $tile.find(`#${_id}-subcategory`).text(subcategory)
      $tile.find(`#${_id}-questionText`).text(questionText)

      if (image) {
        $tile.find('img').removeClass('d-none')
        $form.find('img').removeClass('d-none')

        const path = $tile.find('img').data('image-path')
        $tile.find('img').attr('src', `${path}/${image}`)
        $form.find('img').attr('src', `${path}/${image}`)
      } else {
        $tile.find('img').addClass('d-none')
        $form.find('img').addClass('d-none')
      }

      possibleAnswers.forEach(({val, txt}) => {
        const $option = $tile.find(`#${_id}-possibleAnswers-${val}`)
        $option.text(`${val}. ${txt}`).removeClass('font-weight-bold')
        if (val === correctAnswer) {
          $option.addClass('font-weight-bold')
        }
      })

      $tileFlash.text('Update succeeded.')
      $tileFlash.addClass('alert alert-success')

      $tile.find('.js-question-form').addClass('d-none')
      $tile.find('.js-question-rendered').removeClass('d-none')

      // re-typeset math
      MathJax.Hub.Queue(['Typeset', MathJax.Hub, $tile[0]])
    }).fail(resp => {
      console.error('Request failed. Sent:', request)
      console.error(`Received ${resp.status} response: `, resp.responseText)

      $formFlash.text('Update failed.')
      $formFlash.addClass('alert alert-danger')
    })
  })

  $('.js-question-tile').on('click', '.js-delete-button', e => {
    e.preventDefault()
    const $tile = $(e.target).closest('.js-question-tile')
    const $tileFlash = $tile.find('.js-tile-flash')
    $tileFlash.removeClass('alert alert-danger alert-success')

    const $form = $tile.find('.js-question-form').first()
    const $formFlash = $form.find('.js-form-flash')
    $formFlash.removeClass('alert alert-danger alert-success')

    const questionId = $tile.attr('id')
    const request = {
      type: 'delete',
      contentType: 'application/json; charset=utf-8',
      url: `/edu/questions/${questionId}`,
      dataType: 'json'
    }

    $.ajax(request).done(resp => {
      $tileFlash.text('Successfully deleted')
      $tileFlash.addClass('alert alert-success')
    }).fail(resp => {
      console.error('Request failed. Sent:', request)
      console.error(`Received ${resp.status} response: `, resp.responseText)
      $formFlash.text('Update failed.')
      $formFlash.addClass('alert alert-danger')
    })
  })
</script>
